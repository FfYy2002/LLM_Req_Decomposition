# -*- coding: utf-8 -*-
"""
æ‰¹é‡æ ¹æ® R1-R5 è§„åˆ™æ‹†åˆ† AR_é«˜çº§éœ€æ±‚ â†’ LLM_AR_ç»†èŠ‚éœ€æ±‚

åŠŸèƒ½è¯´æ˜ï¼š
- è¯»å– clean_ar_output/ ç›®å½•ä¸‹æ‰€æœ‰ç¬¦åˆå‘½åè§„èŒƒçš„ Excel æ–‡ä»¶
- è°ƒç”¨å¤§æ¨¡å‹ï¼ˆQwen-Max via DashScopeï¼‰å°†â€œAR_é«˜çº§éœ€æ±‚â€æ‹†åˆ†ä¸ºâ€œLLM_AR_ç»†èŠ‚éœ€æ±‚â€
- è¾“å‡ºç»“æœä¿å­˜è‡³ decomposed_output/ ç›®å½•ï¼Œæ–‡ä»¶åå‰ç¼€æ›¿æ¢ï¼š
    clean_ar_extracted_requirements_*.xlsx â†’ decomposed_requirements_*.xlsx

ä½œè€…ï¼šminefan
æ—¥æœŸï¼š2025å¹´12æœˆ10æ—¥
"""

import os
import pandas as pd
from openai import OpenAI
import threading
import time
import re

# =============================================================================
# å…¨å±€é…ç½®
# =============================================================================
INPUT_DIR = "clean_ar_output"      # è¾“å…¥ç›®å½•ï¼šå­˜æ”¾åŸå§‹éœ€æ±‚æ–‡ä»¶
OUTPUT_DIR = "decomposed_output"   # è¾“å‡ºç›®å½•ï¼šå­˜æ”¾å¤„ç†åçš„ç»“æœæ–‡ä»¶

# ä»ç¯å¢ƒå˜é‡è·å– DashScope API å¯†é’¥
DASHSCOPE_API_KEY = os.getenv("DASHSCOPE_API_KEY")
if not DASHSCOPE_API_KEY:
    raise EnvironmentError(
        "âŒ ç¯å¢ƒå˜é‡ DASHSCOPE_API_KEY æœªè®¾ç½®ã€‚\n"
        "è¯·åœ¨ç»ˆç«¯æ‰§è¡Œï¼šexport DASHSCOPE_API_KEY='sk-xxx'ï¼ˆLinux/macOSï¼‰\n"
        "æˆ–åœ¨ Windows ä¸­é€šè¿‡ç³»ç»Ÿç¯å¢ƒå˜é‡è®¾ç½®ã€‚"
    )

# åˆå§‹åŒ– OpenAI å…¼å®¹å®¢æˆ·ç«¯ï¼ˆDashScopeï¼‰
CLIENT = OpenAI(
    api_key=DASHSCOPE_API_KEY,
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
)

# æ§åˆ¶å¹¶å‘è¯·æ±‚ï¼ˆé¿å…è§¦å‘ API é™æµï¼‰
MAX_CONCURRENT = 6
semaphore = threading.Semaphore(MAX_CONCURRENT)


# =============================================================================
# æç¤ºè¯æ¨¡æ¿ï¼ˆPromptï¼‰
# =============================================================================
PROMPT_TEMPLATE = PROMPT_TEMPLATE = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„éœ€æ±‚å·¥ç¨‹å¸ˆï¼Œè¯·å°†ä»¥ä¸‹â€œé«˜çº§å¼€å‘éœ€æ±‚â€æ‹†åˆ†ä¸ºå¤šä¸ªå…·ä½“çš„â€œç»†èŠ‚å¼€å‘éœ€æ±‚â€ã€‚

è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ‹†åˆ†è§„åˆ™ï¼š

R1ï¼šæ ¹æ®å•ä¸€åœºæ™¯è¿›è¡Œåˆ†è§£
ç»™å®šä¸€ä¸ªå¤æ‚AR ç”±åŠ¨ä½œé›†åˆ A å’Œåœºæ™¯é›†åˆ S å®šä¹‰ï¼Œè‹¥å­˜åœ¨ä¸€ä¸ªåœºæ™¯ s âŠ† Sï¼Œå…¶ä¸­éƒ¨åˆ†åŠ¨ä½œ {{aâ‚–,â€¦,aâ‚š}} ä»…åœ¨ s ä¸­å‡ºç°ï¼ˆå³æœªå‡ºç°åœ¨å…¶ä»–åœºæ™¯ä¸­ï¼‰ï¼Œåˆ™å¯å°† ARåˆ†è§£ä¸ºï¼š
ARaï¼šåŒ…å«å»é™¤äº†è¿™äº›åŠ¨ä½œçš„å…¶ä»–åŠ¨ä½œä¸å…¶ä»–åœºæ™¯ï¼›
ARbï¼šåŒ…å«è¿™äº›åŠ¨ä½œå’Œè¯¥ç‰¹å®šåœºæ™¯ sã€‚
R2ï¼šæ ¹æ®å¤šä¸ªåœºæ™¯åˆ†è§£ï¼ˆR1 çš„æ³›åŒ–ï¼‰
è‹¥å­˜åœ¨å¤šä¸ªåœºæ™¯ Sâ‚ âŠ† Sï¼Œå…¶ä¸­æ¶‰åŠçš„ä¸€ç»„åŠ¨ä½œåœ¨å…¶ä»–åœºæ™¯ä¸­éƒ½æœªå‡ºç°ï¼Œé‚£ä¹ˆå¯ä»¥å°†è¿™äº›åœºæ™¯å’Œç›¸å…³åŠ¨ä½œæå–æˆä¸€ä¸ªæ–°éœ€æ±‚ARbï¼Œå…¶ä½™åœºæ™¯å’ŒåŠ¨ä½œç»„æˆå¦ä¸€ä¸ªéœ€æ±‚ARaã€‚
R3ï¼šå®Œå…¨å…¬å…±éƒ¨åˆ†æå–ä¸º include å…³ç³»
å½“ä¸¤ä¸ªéœ€æ±‚ARâ‚ ä¸ ARâ‚‚ æœ‰ä¸€ç»„åŠ¨ä½œåœ¨å®ƒä»¬æ‰€æœ‰åœºæ™¯ä¸­éƒ½å®Œå…¨ç›¸åŒä¸”éƒ½å‡ºç°æ—¶ï¼Œå¯ä»¥å°†è¿™éƒ¨åˆ†æå–ä¸ºæ–°éœ€æ±‚ARcï¼ŒåŸARé€šè¿‡ include å¼•ç”¨å®ƒã€‚
R4ï¼šéƒ¨åˆ†å…±äº«æå–ä¸º extend å…³ç³»
å¦‚æœä¸¤éœ€æ±‚å…±äº«çš„ä¸€ç»„åŠ¨ä½œåªåœ¨éƒ¨åˆ†åœºæ™¯ä¸­å‡ºç°ï¼Œè€Œéå…¨éƒ¨åœºæ™¯ï¼Œå¯ä»¥æå–è¿™äº›åŠ¨ä½œå½¢æˆä¸€ä¸ªæ–°éœ€æ±‚ ARcï¼ŒåŸARé€šè¿‡ extend ä¸å®ƒå…³è”ã€‚
R5ï¼šç»§æ‰¿å…³ç³»ï¼ˆGeneralizationï¼‰
è‹¥éœ€æ±‚ ARâ‚‚ çš„åŠ¨ä½œé›†åˆæ˜¯ ARâ‚ çš„å­é›†ï¼Œä¸”åœºæ™¯é›†åˆä¹Ÿæ˜¯å…¶å­é›†ï¼Œåˆ™ ARâ‚‚ å¯å®šä¹‰ä¸º ARâ‚ çš„å­ç±»ï¼Œä»…ä¿ç•™å˜åŠ¨çš„éƒ¨åˆ†ï¼Œå¹¶é€šè¿‡ç»§æ‰¿è¿æ¥ã€‚

ã€é‡è¦è¡¥å……è¦æ±‚ã€‘
- å¿…é¡»å®Œæ•´ä¿ç•™åŸå§‹é«˜çº§éœ€æ±‚ä¸­çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š
  â€¢ æ­£å¸¸åŠŸèƒ½æµç¨‹ï¼ˆä¸»è·¯å¾„ï¼‰
  â€¢ æ‰€æœ‰è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸åœºæ™¯ï¼ˆå¦‚æ•°æ®ä¸ºç©ºã€æ“ä½œå¤±è´¥ã€çŠ¶æ€å†²çªç­‰ï¼‰
  â€¢ æ‰€æœ‰éåŠŸèƒ½æ€§è¦æ±‚ï¼ˆåœ¨æœ«å°¾ä½¿ç”¨â€œè¯´æ˜ï¼šâ€è¡¥å……éåŠŸèƒ½æ€§è¦æ±‚ï¼ˆå¦‚æ’åºã€ç¼“å­˜ã€æ€§èƒ½ï¼‰ï¼Œä½†ä»…é™åŸå§‹éœ€æ±‚éšå«æˆ–è¡Œä¸šå¸¸è¯†ï¼ˆä¾‹å¦‚â€œé¢‘é“æŒ‰é¢‘é“å·å‡åºæ’åˆ—â€ï¼‰ï¼‰
- ä¸å¾—åé—®ï¼Œä¸å¾—è¯·æ±‚ç”¨æˆ·æä¾›æ›´å¤šä¿¡æ¯
- ä¸è¦ç¼–é€ åŸå§‹é«˜çº§éœ€æ±‚ä¸­æœªæåŠçš„åŠŸèƒ½ã€è§’è‰²æˆ–æ•°æ®

ã€è¾“å‡ºæ ¼å¼å¼ºåˆ¶è§„èŒƒã€‘
1. å°†æ‰€æœ‰å†…å®¹ï¼ˆæ­£å¸¸åŠŸèƒ½ã€è¾¹ç•Œæ¡ä»¶ã€å¼‚å¸¸å¤„ç†ï¼‰åˆå¹¶ä¸ºä¸€ä¸ªä» 1 å¼€å§‹çš„è¿ç»­ç¼–å·åˆ—è¡¨ã€‚
2. åœ¨æ­£å¸¸åŠŸèƒ½ç»“æŸåï¼Œå¦èµ·ä¸€è¡Œå†™ï¼šâ€œè¾¹ç•Œæˆ–å¼‚å¸¸åœºæ™¯å¤„ç†ï¼šâ€ï¼Œä½†æ­¤æ ‡é¢˜ä¸å ç¼–å·ï¼Œå…¶åæ¡ç›®å¿…é¡»æ¥ç»­å‰é¢çš„åºå·ã€‚
3. å¦‚æœ‰éåŠŸèƒ½æ€§è¯´æ˜ï¼Œåœ¨æœ€åå¦èµ·ä¸€è¡Œå†™ï¼šâ€œè¯´æ˜ï¼šâ€ï¼Œç„¶åç”¨â€œ- â€åˆ—å‡ºå„é¡¹ï¼Œè¯´æ˜å†…å®¹ä¸å‚ä¸ç¼–å·ã€‚
4. æ¯æ¡ç¼–å·é¡¹å¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´å¥å­ï¼Œä»¥â€œã€‚â€ç»“å°¾ã€‚
5. ç¦æ­¢ä½¿ç”¨é¡¹ç›®ç¬¦å·ï¼ˆå¦‚ -ã€â€¢ã€*ï¼‰ã€å­ç¼–å·ï¼ˆå¦‚ 1.1ï¼‰ã€æˆ–ä»»ä½•è§£é‡Šæ€§æ–‡å­—ï¼ˆå¦‚â€œæ ¹æ® R1â€ã€â€œç»¼ä¸Šæ‰€è¿°â€ï¼‰ã€‚

ã€ç¤ºä¾‹è¾“å‡ºã€‘
1. æä¾›ä¸€ä¸ªç•Œé¢ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹æ‰€æœ‰è¯·æ±‚ã€‚
2. ç”¨æˆ·å¯ç‚¹å‡»ä»»ä¸€è¯·æ±‚æŸ¥çœ‹è¯¦æƒ…ã€‚
3. æ”¯æŒæŒ‰çŠ¶æ€ç­›é€‰è¯·æ±‚åˆ—è¡¨ã€‚

è¾¹ç•Œæˆ–å¼‚å¸¸åœºæ™¯å¤„ç†ï¼š
4. å½“è¯·æ±‚ ID ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›â€œè¯·æ±‚æœªæ‰¾åˆ°â€é”™è¯¯æç¤ºã€‚
5. è‹¥ç½‘ç»œè¶…æ—¶ï¼Œæ˜¾ç¤ºâ€œåŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•â€ã€‚

è¯´æ˜ï¼š
- è¯·æ±‚åˆ—è¡¨é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—ã€‚
- åˆ—è¡¨é¡µéœ€æ”¯æŒåˆ†é¡µåŠ è½½ã€‚

ã€é«˜çº§å¼€å‘éœ€æ±‚ã€‘
{high_ar}"""


def call_llm(high_ar: str) -> str:
    """
    è°ƒç”¨å¤§æ¨¡å‹å°†é«˜çº§éœ€æ±‚æ‹†åˆ†ä¸ºç»†èŠ‚éœ€æ±‚ã€‚

    å‚æ•°:
        high_ar (str): é«˜çº§éœ€æ±‚æ–‡æœ¬

    è¿”å›:
        str: ç¼–å·æ ¼å¼çš„ç»†èŠ‚éœ€æ±‚åˆ—è¡¨ï¼ˆå¦‚ "1. ...\n2. ..."ï¼‰ï¼Œå¤±è´¥æ—¶è¿”å› fallback æ ¼å¼
    """
    # å¤„ç†ç©ºå€¼æˆ– NaN
    if not high_ar or pd.isna(high_ar):
        return ""

    # æˆªæ–­è¿‡é•¿è¾“å…¥ï¼ˆé˜²æ­¢ token è¶…é™ï¼‰
    clean_high = str(high_ar).strip()[:2000]
    prompt = PROMPT_TEMPLATE.format(high_ar=clean_high)

    # æœ€å¤šé‡è¯• 3 æ¬¡
    for attempt in range(3):
        try:
            with semaphore:  # æ§åˆ¶å¹¶å‘
                response = CLIENT.chat.completions.create(
                    model="qwen-max",
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.3,
                    timeout=30
                )
            output = response.choices[0].message.content.strip()

            # åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆç¼–å·åˆ—è¡¨ï¼ˆä»¥ 1. å¼€å¤´å³å¯ï¼Œä¸è¦æ±‚å¤šæ¡ï¼‰
            if re.search(r"^\s*1\.", output, re.MULTILINE):
                return output
            else:
                # fallbackï¼šå°†åŸå§‹å†…å®¹è½¬ä¸ºç¼–å·æ ¼å¼ï¼ˆå…è®¸å•è¡Œï¼‰
                lines = [line.strip() for line in clean_high.split('\n') if line.strip()]
                if lines:
                    return "\n".join([f"{i+1}. {line}" for i, line in enumerate(lines)])
                else:
                    return "1. æ— æœ‰æ•ˆéœ€æ±‚å†…å®¹"

        except Exception as e:
            if attempt == 2:  # æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥
                print(f"[WARN] LLM è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨ fallback | é”™è¯¯: {e}")
                lines = [line.strip() for line in clean_high.split('\n') if line.strip()]
                if lines:
                    return "\n".join([f"{i+1}. {line}" for i, line in enumerate(lines)])
                else:
                    return "1. æ— æœ‰æ•ˆéœ€æ±‚å†…å®¹"
            time.sleep(2)  # é‡è¯•å‰ç­‰å¾…
    return "1. LLM è°ƒç”¨å¤±è´¥"


def process_file(filepath: str):
    """
    å¤„ç†å•ä¸ª Excel æ–‡ä»¶ï¼šè¯»å–ã€è°ƒç”¨ LLMã€ä¿å­˜ç»“æœã€‚

    å‚æ•°:
        filepath (str): è¾“å…¥æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
    """
    filename = os.path.basename(filepath)
    print(f"\n[INFO] æ­£åœ¨å¤„ç†æ–‡ä»¶: {filename}")

    # å°è¯•è¯»å– Excel æ–‡ä»¶
    try:
        df = pd.read_excel(filepath)
    except Exception as e:
        print(f"  âœ˜ è¯»å–å¤±è´¥: {e}")
        return

    # æ£€æŸ¥å¿…éœ€åˆ—æ˜¯å¦å­˜åœ¨
    required_cols = ["AR_é«˜çº§éœ€æ±‚", "AR_ç»†èŠ‚éœ€æ±‚"]
    missing = [col for col in required_cols if col not in df.columns]
    if missing:
        print(f"  âš  è·³è¿‡ï¼šç¼ºå°‘å¿…è¦åˆ— {missing}")
        return

    # ä»…å¤„ç†ç¬¦åˆå‘½åè§„èŒƒçš„æ–‡ä»¶
    if not filename.startswith("clean_ar_extracted_requirements_"):
        print(f"  âš  è·³è¿‡ï¼šæ–‡ä»¶åä¸ç¬¦åˆ 'clean_ar_extracted_requirements_' å‰ç¼€")
        return

    # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼šæ›¿æ¢å‰ç¼€
    output_filename = filename.replace("clean_ar_extracted", "decomposed", 1)
    output_path = os.path.join(OUTPUT_DIR, output_filename)

    print(f"  å…± {len(df)} è¡Œéœ€æ±‚ï¼Œå¼€å§‹è°ƒç”¨ LLM...")

    # é€è¡Œå¤„ç†é«˜çº§éœ€æ±‚
    decomposed_list = []
    for idx, row in df.iterrows():
        high_ar = row["AR_é«˜çº§éœ€æ±‚"]
        low_ar = call_llm(high_ar)
        decomposed_list.append(low_ar)

        # æ¯å¤„ç† 10 è¡Œæ‰“å°è¿›åº¦
        if (idx + 1) % 10 == 0:
            print(f"    å·²å¤„ç† {idx + 1}/{len(df)}")

    # æ–°å¢ç»“æœåˆ—
    df["LLM_AR_ç»†èŠ‚éœ€æ±‚"] = decomposed_list

    # ä¿å­˜åˆ°è¾“å‡ºç›®å½•
    try:
        df.to_excel(output_path, index=False, engine="openpyxl")
        print(f"  âœ“ å¤„ç†å®Œæˆï¼è¾“å‡ºè·¯å¾„: {output_path}")
    except Exception as e:
        print(f"  âœ˜ ä¿å­˜å¤±è´¥: {e}")


def main():
    """
    ä¸»å‡½æ•°ï¼šæ‰«æè¾“å…¥ç›®å½•ï¼Œæ‰¹é‡å¤„ç†æ–‡ä»¶ã€‚
    """
    # è‡ªåŠ¨åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    os.makedirs(OUTPUT_DIR, exist_ok=True)

    # æ‰«æè¾“å…¥ç›®å½•ä¸­ç¬¦åˆè§„èŒƒçš„æ–‡ä»¶
    input_files = [
        f for f in os.listdir(INPUT_DIR)
        if f.endswith(".xlsx")                  # å¿…é¡»æ˜¯ Excel æ–‡ä»¶
           and not f.startswith("~$")              # è·³è¿‡ Excel ä¸´æ—¶æ–‡ä»¶
           and f.startswith("clean_ar_extracted_requirements_")  # ä¸¥æ ¼åŒ¹é…å‰ç¼€
    ]

    if not input_files:
        raise FileNotFoundError(
            f"åœ¨ç›®å½• '{INPUT_DIR}' ä¸­æœªæ‰¾åˆ°ç¬¦åˆå‘½åè§„èŒƒçš„æ–‡ä»¶ "
            "(åº”ä»¥ 'clean_ar_extracted_requirements_' å¼€å¤´)"
        )

    print(f"[INFO] å‘ç° {len(input_files)} ä¸ªå¾…å¤„ç†æ–‡ä»¶")

    # ä¾æ¬¡å¤„ç†æ¯ä¸ªæ–‡ä»¶ï¼ˆé¡ºåºæ‰§è¡Œï¼Œé¿å…èµ„æºç«äº‰ï¼‰
    for filename in input_files:
        filepath = os.path.join(INPUT_DIR, filename)
        process_file(filepath)

    print(f"\nğŸ‰ æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæ¯•ï¼ç»“æœå·²ä¿å­˜è‡³ç›®å½•: '{OUTPUT_DIR}/'")


if __name__ == "__main__":
    main()